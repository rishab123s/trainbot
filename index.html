<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Technical Analysis Trading Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0/dist/chartjs-plugin-annotation.min.js"></script>
    <!-- Library for Candlestick charts -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .rating-buy, .sentiment-bullish { color: #22c55e; }
        .rating-sell, .sentiment-bearish { color: #ef4444; }
        .rating-hold, .sentiment-neutral { color: #eab308; }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-top: -25px;
            margin-left: -25px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .info-icon {
            cursor: pointer;
            display: inline-block;
            margin-left: 8px;
            color: #9ca3af;
            border: 1px solid #9ca3af;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            text-align: center;
            line-height: 18px;
            font-style: italic;
            font-weight: bold;
        }
        .info-tooltip {
            display: none;
            position: absolute;
            background-color: #1f2937;
            color: #e5e7eb;
            border: 1px solid #4b5563;
            padding: 10px;
            border-radius: 8px;
            z-index: 100;
            width: 250px;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            right: 10px;
        }
        .chart-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        .tab-btn.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">Trading Signal Bot</h1>
            <p class="text-gray-400 mt-2">Analyze stock trends with technical indicators</p>
        </header>

        <main>
            <!-- Input Section -->
            <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-8 max-w-4xl mx-auto">
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <div class="flex-grow w-full">
                        <label for="ticker" class="sr-only">Stock Ticker</label>
                        <input type="text" id="ticker" class="w-full bg-gray-700 text-white border border-gray-600 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter Stock Ticker (e.g., AAPL)">
                    </div>
                    <button id="fetchData" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-md transition duration-300 ease-in-out transform hover:scale-105">
                        Analyze
                    </button>
                </div>
                 <div class="text-xs text-gray-500 mt-2 text-center">
                    Uses Alpha Vantage API. Free tier has limitations. News endpoint may be premium.
                </div>
            </div>
            
            <!-- Loading Spinner -->
            <div id="loader" class="loader hidden"></div>
            
            <!-- Error Message -->
            <div id="error-message" class="hidden bg-red-900 border border-red-400 text-red-100 px-4 py-3 rounded-lg relative max-w-4xl mx-auto text-center my-4" role="alert">
                <strong class="font-bold">Error:</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <!-- Main Content Area -->
            <div id="main-content" class="hidden max-w-4xl mx-auto">
                <!-- Tabs -->
                <div class="border-b border-gray-700 mb-4">
                    <nav class="flex -mb-px">
                        <button class="tab-btn active" data-tab="long-term">Long Term</button>
                        <button class="tab-btn" data-tab="intraday">Intraday</button>
                    </nav>
                </div>

                <!-- Long Term Tab Content -->
                <div id="long-term-content" class="tab-content active">
                    <div id="long-term-results">
                        <!-- Rating Display -->
                        <div class="bg-gray-800 rounded-lg shadow-lg p-6 mb-8 text-center">
                            <h2 class="text-2xl font-semibold" id="stockName-long"></h2>
                            <p class="text-5xl font-bold" id="rating-long"></p>
                            <p class="text-gray-400 mt-2" id="rating-explanation-long"></p>
                            <p class="text-xs text-gray-500 mt-4" id="markers-explanation-long"></p>
                        </div>
                        <!-- Charts Section -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-gray-800 rounded-lg shadow-lg p-4 relative h-80"><div class="chart-container"><h3 class="text-lg font-semibold text-center mb-2">Price & Volatility <span class="info-icon" data-tooltip="price-tooltip">i</span></h3><canvas id="priceChart-long"></canvas><div id="price-tooltip" class="info-tooltip">This chart shows price with Bollinger Bands (the shaded area). These bands measure volatility. When price hits the upper band, it may be overbought; when it hits the lower band, it may be oversold. The lines are moving averages (SMAs) that show the trend.</div></div></div>
                            <div class="bg-gray-800 rounded-lg shadow-lg p-4 relative h-80"><div class="chart-container"><h3 class="text-lg font-semibold text-center mb-2">Volume <span class="info-icon" data-tooltip="volume-tooltip">i</span></h3><canvas id="volumeChart-long"></canvas><div id="volume-tooltip" class="info-tooltip">Volume represents the number of shares traded. High volume can confirm the strength of a price trend. A price increase on high volume is more significant than one on low volume. The line shows the 20-day average volume.</div></div></div>
                            <div class="bg-gray-800 rounded-lg shadow-lg p-4 relative h-80"><div class="chart-container"><h3 class="text-lg font-semibold text-center mb-2">Relative Strength Index (RSI) <span class="info-icon" data-tooltip="rsi-tooltip">i</span></h3><canvas id="rsiChart-long"></canvas><div id="rsi-tooltip" class="info-tooltip">RSI is a momentum oscillator. A stock is generally considered overbought (pullback likely) when RSI is above 70, and oversold (bounce likely) when it's below 30.</div></div></div>
                            <div class="bg-gray-800 rounded-lg shadow-lg p-4 relative h-80"><div class="chart-container"><h3 class="text-lg font-semibold text-center mb-2">MACD <span class="info-icon" data-tooltip="macd-tooltip">i</span></h3><canvas id="macdChart-long"></canvas><div id="macd-tooltip" class="info-tooltip">The Moving Average Convergence Divergence (MACD) is a trend-following momentum indicator. When the blue MACD line crosses above the orange Signal line, it's a bullish signal. The bars (histogram) show the strength of the momentum.</div></div></div>
                        </div>
                    </div>
                </div>

                <!-- Intraday Tab Content -->
                <div id="intraday-content" class="tab-content">
                    <!-- This content will be loaded on demand -->
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DOM Elements & State ---
        const fetchDataBtn = document.getElementById('fetchData');
        const tickerInput = document.getElementById('ticker');
        const mainContentEl = document.getElementById('main-content');
        const loader = document.getElementById('loader');
        const errorMessageDiv = document.getElementById('error-message');
        const errorTextEl = document.getElementById('error-text');
        let chartInstances = {};
        let currentTicker = '';
        let dailyDataCache = null; // Cache daily data for intraday tab
        let intradayDataLoaded = false; // Flag to prevent re-fetching
        const API_KEY = '4OI0XJ2TFMM39PDX'; // IMPORTANT: Replace with your key

        // --- Event Listeners ---
        fetchDataBtn.addEventListener('click', () => getStockData(tickerInput.value));
        tickerInput.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') getStockData(tickerInput.value);
        });
        
        document.querySelector('.tab-btn[data-tab="intraday"]').addEventListener('click', handleIntradayTabClick);
        document.querySelector('.tab-btn[data-tab="long-term"]').addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.querySelector('.tab-btn[data-tab="long-term"]').classList.add('active');
            document.getElementById('long-term-content').classList.add('active');
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            setupInfoTooltips();
        });

        // --- Main Data Fetching Logic ---
        async function getStockData(tickerSymbol) {
            currentTicker = tickerSymbol.trim().toUpperCase();
            if (!currentTicker) {
                showError('Please enter a stock ticker.');
                return;
            }
            showLoader(true);
            hideError();
            mainContentEl.classList.add('hidden');
            intradayDataLoaded = false; // Reset flag for new stock
            
            // Reset tabs to default state
            document.querySelector('.tab-btn[data-tab="long-term"]').click();

            try {
                // ONLY fetch daily data initially
                const dailyRes = await fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${currentTicker}&outputsize=full&apikey=${API_KEY}`);
                const dailyData = await dailyRes.json();
                validateApiResponse(dailyData, "Daily");
                
                dailyDataCache = dailyData['Time Series (Daily)']; // Cache for later
                processLongTermData(currentTicker, dailyDataCache);
                
                mainContentEl.classList.remove('hidden');
            } catch (error) {
                showError(error.message);
            } finally {
                showLoader(false);
            }
        }
        
        async function handleIntradayTabClick() {
            // Activate tab UI first
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            this.classList.add('active');
            document.getElementById('intraday-content').classList.add('active');

            if (intradayDataLoaded) return; // Don't re-fetch if already loaded

            const intradayContainer = document.getElementById('intraday-content');
            intradayContainer.innerHTML = '<div class="text-center p-8">Loading Intraday Data...</div>';
            
            try {
                const [intradayRes, newsRes] = await Promise.all([
                    fetch(`https://www.alphavantage.co/query?function=TIME_SERIES_INTRADAY&symbol=${currentTicker}&interval=15min&outputsize=full&apikey=${API_KEY}`),
                    fetch(`https://www.alphavantage.co/query?function=NEWS_SENTIMENT&tickers=${currentTicker}&limit=20&apikey=${API_KEY}`)
                ]);
                const intradayData = await intradayRes.json();
                const newsData = await newsRes.json();

                validateApiResponse(intradayData, "Intraday");
                
                // Inject the HTML structure for the intraday tab
                intradayContainer.innerHTML = `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="md:col-span-2 space-y-8">
                            <div class="bg-gray-800 rounded-lg shadow-lg p-4 relative h-96"><div class="chart-container"><h3 class="text-lg font-semibold text-center mb-2">Intraday (15min) Chart <span class="info-icon" data-tooltip="intraday-chart-tooltip">i</span></h3><canvas id="intradayChart"></canvas><div id="intraday-chart-tooltip" class="info-tooltip"><b>Candlestick:</b> Shows the open, high, low, and close price for each 15-min period. A green candle means the price closed higher than it opened; red means it closed lower.<br><br><b>VWAP (Yellow Line):</b> The Volume Weighted Average Price. A key level watched by institutions. Price trading above it is generally bullish for the day; below is bearish.</div></div></div>
                            <div class="bg-gray-800 rounded-lg shadow-lg p-4 relative h-48"><div class="chart-container"><h3 class="text-lg font-semibold text-center mb-2">Intraday Volume</h3><canvas id="intradayVolumeChart"></canvas></div></div>
                        </div>
                        <div class="space-y-8">
                            <div class="bg-gray-800 rounded-lg shadow-lg p-4"><h3 class="text-lg font-semibold text-center mb-3">Key Intraday Levels</h3><div id="pivot-levels" class="space-y-2 text-sm"></div></div>
                            <div class="bg-gray-800 rounded-lg shadow-lg p-4"><h3 class="text-lg font-semibold text-center mb-3">News Sentiment</h3><div id="news-sentiment-overall" class="text-center font-bold text-xl mb-3"></div><div id="news-feed" class="space-y-3 text-xs"></div></div>
                        </div>
                    </div>`;
                
                setupInfoTooltips(); // Re-initialize tooltips for new elements
                processIntradayData(currentTicker, intradayData['Time Series (15min)'], dailyDataCache);
                processNewsData(newsData);
                intradayDataLoaded = true;

            } catch (error) {
                intradayContainer.innerHTML = `<p class="text-center text-red-500 p-8">${error.message}</p>`;
            }
        }
        
        function validateApiResponse(data, type) {
            if (data['Information'] || data['Note'] || data['Error Message']) {
                throw new Error(`API Error (${type}): ${data['Information'] || data['Note'] || data['Error Message']}`);
            }
        }

        // --- Long Term Analysis ---
        function processLongTermData(ticker, dailyData) {
            const stockNameEl = document.getElementById('stockName-long');
            const ratingEl = document.getElementById('rating-long');
            const ratingExplanationEl = document.getElementById('rating-explanation-long');
            const markersExplanationEl = document.getElementById('markers-explanation-long');

            const dates = Object.keys(dailyData).reverse();
            const closes = dates.map(date => parseFloat(dailyData[date]['4. close']));
            const volumes = dates.map(date => parseInt(dailyData[date]['5. volume']));
            const sma50 = calculateSMA(closes, 50);
            const rsi = calculateRSI(closes, 14);
            const { macd, signal, hist } = calculateMACD(closes);
            const bb = calculateBollingerBands(closes, 20, 2);
            
            const displayDates = dates.slice(-200);
            const displayCloses = closes.slice(-200);
            const displayVolumes = volumes.slice(-200);
            const displaySma50 = sma50.slice(-200);
            const displayVolumeSma20 = calculateSMA(displayVolumes, 20);
            const displayRsi = rsi.slice(-200);
            const displayMacd = macd.slice(-200);
            const displaySignal = signal.slice(-200);
            const displayHist = hist.slice(-200);
            const displayBB = { upper: bb.upper.slice(-200), middle: bb.middle.slice(-200), lower: bb.lower.slice(-200) };

            const { rating, explanation } = generateTradingRating({ closes: displayCloses, rsi: displayRsi, macd: displayMacd, signal: displaySignal, bb: displayBB }, displayBB.middle, displaySma50, displayVolumes, displayVolumeSma20);

            if(stockNameEl) stockNameEl.textContent = `${ticker} Long Term Analysis`;
            if(ratingEl) ratingEl.textContent = rating;
            if(ratingEl) ratingEl.className = `text-5xl font-bold rating-${rating.toLowerCase()}`;
            if(ratingExplanationEl) ratingExplanationEl.textContent = explanation;
            if(markersExplanationEl) markersExplanationEl.innerHTML = `<span class="text-green-500">▲</span> Entry Signal &nbsp;&nbsp; <span class="text-red-500">▼</span> Exit Signal`;
            
            const chartSignals = findChartSignals(displayDates, displayCloses, displayBB.middle, displaySma50);

            createOrUpdateChart('priceChart-long', { labels: displayDates, datasets: [ { label: 'Close Price', data: displayCloses, borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, tension: 0.1 }, { label: 'Upper Band', data: displayBB.upper, borderColor: 'rgba(167, 139, 250, 0.2)', borderWidth: 1, pointRadius: 0, fill: '+1', backgroundColor: 'rgba(167, 139, 250, 0.1)' }, { label: 'Lower Band', data: displayBB.lower, borderColor: 'rgba(167, 139, 250, 0.2)', borderWidth: 1, pointRadius: 0, fill: false }, { label: 'SMA 20 (BB Middle)', data: displayBB.middle, borderColor: '#f97316', borderWidth: 1.5, pointRadius: 0, borderDash: [5, 5] }, { label: 'SMA 50', data: displaySma50, borderColor: '#a855f7', borderWidth: 1.5, pointRadius: 0 } ] }, 'line', {}, chartSignals);
            createOrUpdateChart('volumeChart-long', { labels: displayDates, datasets: [ { label: 'Volume', data: displayVolumes, backgroundColor: '#4b5563', type: 'bar' }, { label: 'Volume SMA 20', data: displayVolumeSma20, borderColor: '#f97316', borderWidth: 2, pointRadius: 0, tension: 0.1, type: 'line' } ] }, 'bar');
            createOrUpdateChart('rsiChart-long', { labels: displayDates, datasets: [{ label: 'RSI', data: displayRsi, borderColor: '#10b981', borderWidth: 2, pointRadius: 0, tension: 0.1 }] }, 'line', { y: { min: 0, max: 100 } });
            createOrUpdateChart('macdChart-long', { labels: displayDates, datasets: [ { label: 'MACD Histogram', data: displayHist, backgroundColor: (c) => c.raw >= 0 ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)' }, { label: 'MACD', data: displayMacd, type: 'line', borderColor: '#3b82f6', borderWidth: 2, pointRadius: 0, tension: 0.1 }, { label: 'Signal Line', data: displaySignal, type: 'line', borderColor: '#f97316', borderWidth: 2, pointRadius: 0, tension: 0.1 } ] }, 'bar');
        }

        // --- Intraday Analysis ---
        function processIntradayData(ticker, intradayData, dailyData) {
            const intradayContentEl = document.getElementById('intraday-content');
            if(!intradayData || !intradayContentEl) {
                if(intradayContentEl) intradayContentEl.innerHTML = `<p class="text-center text-yellow-500">Intraday data not available for ${ticker}. This may be a premium feature.</p>`;
                return;
            }
            
            const intradayDates = Object.keys(intradayData).reverse();
            const todayStr = new Date().toISOString().slice(0, 10);
            const todayDates = intradayDates.filter(date => date.startsWith(todayStr));

            if (todayDates.length === 0) {
                 intradayContentEl.innerHTML = `<p class="text-center text-yellow-500">Market is closed. Intraday data is for the current trading day.</p>`;
                 return;
            }

            const candlestickData = todayDates.map(date => ({
                t: new Date(date).getTime(),
                o: parseFloat(intradayData[date]['1. open']),
                h: parseFloat(intradayData[date]['2. high']),
                l: parseFloat(intradayData[date]['3. low']),
                c: parseFloat(intradayData[date]['4. close']),
                v: parseInt(intradayData[date]['5. volume'])
            }));

            const intradayVolumes = candlestickData.map(d => d.v);
            const vwapData = calculateVWAP(candlestickData);

            const dailyDates = Object.keys(dailyData).sort().reverse();
            if (dailyDates.length < 2) {
                displayPivotPoints(null); // Not enough data for pivots
            } else {
                const prevDay = dailyData[dailyDates[1]];
                const high = parseFloat(prevDay['2. high']);
                const low = parseFloat(prevDay['3. low']);
                const close = parseFloat(prevDay['4. close']);
                const pivots = calculatePivotPoints(high, low, close);
                displayPivotPoints(pivots);
                const pivotAnnotations = Object.entries(pivots).map(([key, value]) => ({ type: 'line', yMin: value, yMax: value, borderColor: key.startsWith('R') ? 'rgba(239, 68, 68, 0.5)' : 'rgba(34, 197, 94, 0.5)', borderWidth: 2, borderDash: [5, 5], label: { content: `${key}: ${value.toFixed(2)}`, enabled: true, position: 'end', backgroundColor: 'rgba(0,0,0,0.6)', font: { size: 10 }, color: key.startsWith('R') ? '#ef4444' : '#22c55e' } }));
                createOrUpdateChart('intradayChart', { datasets: [{ label: 'Candlestick', data: candlestickData }, { label: 'VWAP', data: vwapData, type: 'line', borderColor: '#facc15', borderWidth: 2, pointRadius: 0, tension: 0.1 }] }, 'candlestick', {}, [], pivotAnnotations);
            }
            
            const volumeChartData = { labels: todayDates, datasets: [{ label: 'Volume', data: intradayVolumes, backgroundColor: (c) => { if (c.dataIndex > 0 && candlestickData[c.dataIndex]) { const currentCandle = candlestickData[c.dataIndex]; const prevCandle = candlestickData[c.dataIndex - 1]; return currentCandle.c >= prevCandle.c ? 'rgba(34, 197, 94, 0.5)' : 'rgba(239, 68, 68, 0.5)'; } return 'rgba(107, 114, 128, 0.5)'; } }] };
            createOrUpdateChart('intradayVolumeChart', volumeChartData, 'bar', { y: { ticks: { display: false } } });
        }
        
        function displayPivotPoints(pivots) {
            const container = document.getElementById('pivot-levels');
            if (!container) return;
            if (!pivots) {
                container.innerHTML = `<p class="text-center text-gray-500">Not enough daily data to calculate pivot points.</p>`;
                return;
            }
            container.innerHTML = `
                <div class="flex justify-between text-red-400"><span>Resistance 2 (R2)</span><span>${pivots.R2.toFixed(2)}</span></div>
                <div class="flex justify-between text-red-500"><span>Resistance 1 (R1)</span><span>${pivots.R1.toFixed(2)}</span></div>
                <div class="flex justify-between font-bold"><span>Pivot Point (P)</span><span>${pivots.P.toFixed(2)}</span></div>
                <div class="flex justify-between text-green-500"><span>Support 1 (S1)</span><span>${pivots.S1.toFixed(2)}</span></div>
                <div class="flex justify-between text-green-400"><span>Support 2 (S2)</span><span>${pivots.S2.toFixed(2)}</span></div>`;
        }

        // --- News Analysis ---
        function processNewsData(newsData) {
            const overallContainer = document.getElementById('news-sentiment-overall');
            const feedContainer = document.getElementById('news-feed');
            if(!overallContainer || !feedContainer) return;

            if (!newsData || !newsData.feed || newsData.feed.length === 0) {
                overallContainer.textContent = 'Unavailable';
                overallContainer.className = 'text-center font-bold text-xl sentiment-neutral';
                feedContainer.innerHTML = '<p class="text-gray-500 text-center">No news found or endpoint is premium.</p>';
                return;
            }
            const overallScore = parseFloat(newsData.items) > 0 ? (newsData.feed.reduce((acc, item) => acc + (parseFloat(item.overall_sentiment_score) || 0), 0) / newsData.items) : 0;
            let sentimentLabel = 'Neutral', sentimentClass = 'sentiment-neutral';
            if (overallScore >= 0.15) { sentimentLabel = 'Bullish'; sentimentClass = 'sentiment-bullish'; }
            else if (overallScore <= -0.15) { sentimentLabel = 'Bearish'; sentimentClass = 'sentiment-bearish'; }
            overallContainer.textContent = sentimentLabel;
            overallContainer.className = `text-center font-bold text-xl ${sentimentClass}`;
            feedContainer.innerHTML = '';
            newsData.feed.slice(0, 3).forEach(item => {
                const sentiment = item.overall_sentiment_label.toLowerCase();
                const articleEl = document.createElement('a');
                articleEl.href = item.url;
                articleEl.target = '_blank';
                articleEl.className = 'block bg-gray-700 p-2 rounded-md hover:bg-gray-600';
                articleEl.innerHTML = `<p class="font-bold truncate">${item.title}</p><div class="flex justify-between items-center text-gray-400"><span>${item.source}</span><span class="font-bold sentiment-${sentiment}">${item.overall_sentiment_label}</span></div>`;
                feedContainer.appendChild(articleEl);
            });
        }

        // --- Indicator Calculation & Rating Logic ---
        function calculateSMA(data, period) { const sma = []; for (let i = 0; i < data.length; i++) { if (i < period - 1) { sma.push(null); } else { const sum = data.slice(i - period + 1, i + 1).reduce((a, b) => a + b, 0); sma.push(sum / period); } } return sma; }
        function calculateEMA(data, period) { const multiplier = 2 / (period + 1); const ema = []; let prevEma = null; for (let i = 0; i < data.length; i++) { if (i < period - 1) { ema.push(null); continue; } if (i === period - 1) { const sum = data.slice(0, period).reduce((a, b) => a + b, 0); prevEma = sum / period; ema.push(prevEma); } else { const currentEma = (data[i] - prevEma) * multiplier + prevEma; ema.push(currentEma); prevEma = currentEma; } } return ema; }
        function calculateRSI(data, period = 14) { const rsi = []; let avgGain = 0; let avgLoss = 0; for (let i = 1; i < data.length; i++) { const change = data[i] - data[i-1]; const gain = change > 0 ? change : 0; const loss = change < 0 ? -change : 0; if (i < period) { avgGain += gain; avgLoss += loss; rsi.push(null); } else if (i === period) { avgGain = (avgGain + gain) / period; avgLoss = (avgLoss + loss) / period; const rs = avgLoss === 0 ? 100 : avgGain / avgLoss; rsi.push(100 - (100 / (1 + rs))); } else { avgGain = (avgGain * (period - 1) + gain) / period; avgLoss = (avgLoss * (period - 1) + loss) / period; const rs = avgLoss === 0 ? 100 : avgGain / avgLoss; rsi.push(100 - (100 / (1 + rs))); } } rsi.unshift(null); return rsi; }
        function calculateMACD(data, shortPeriod = 12, longPeriod = 26, signalPeriod = 9) { const emaShort = calculateEMA(data, shortPeriod); const emaLong = calculateEMA(data, longPeriod); const macdLine = emaShort.map((val, i) => val !== null && emaLong[i] !== null ? val - emaLong[i] : null); const signalLine = calculateEMA(macdLine.filter(v => v !== null), signalPeriod); const alignedSignal = Array(macdLine.length - signalLine.length).fill(null).concat(signalLine); const hist = macdLine.map((val, i) => val !== null && alignedSignal[i] !== null ? val - alignedSignal[i] : null); return { macd: macdLine, signal: alignedSignal, hist: hist }; }
        function calculateBollingerBands(data, period = 20, stdDev = 2) { const middle = calculateSMA(data, period); const upper = []; const lower = []; for (let i = 0; i < data.length; i++) { if (i < period - 1) { upper.push(null); lower.push(null); } else { const slice = data.slice(i - period + 1, i + 1); const mean = middle[i]; const variance = slice.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / period; const sd = Math.sqrt(variance); upper.push(mean + sd * stdDev); lower.push(mean - sd * stdDev); } } return { upper, middle, lower }; }
        function calculateVWAP(data) { const vwap = []; let cumulativeTPV = 0; let cumulativeVolume = 0; for (const item of data) { const typicalPrice = (item.h + item.l + item.c) / 3; const tpv = typicalPrice * item.v; cumulativeTPV += tpv; cumulativeVolume += item.v; vwap.push(cumulativeVolume > 0 ? cumulativeTPV / cumulativeVolume : null); } return vwap; }
        function calculatePivotPoints(high, low, close) { const P = (high + low + close) / 3; const R1 = (2 * P) - low; const S1 = (2 * P) - high; const R2 = P + (high - low); const S2 = P - (high - low); return { R2, R1, P, S1, S2 }; }
        function generateTradingRating(data, sma20, sma50, volumes, volumeSma20) { let score = 0; const len = data.closes.length; if (len < 50) return { rating: 'HOLD', explanation: 'Not enough data for a reliable signal.' }; const lastClose = data.closes[len - 1], prevClose = data.closes[len - 2], lastSma20 = sma20[len - 1], lastSma50 = sma50[len - 1], lastVolume = volumes[len - 1], lastVolumeSma20 = volumeSma20[len - 1], lastRsi = data.rsi[len - 1], lastMacd = data.macd[len - 1], lastMacdSignal = data.signal[len - 1], lastUpperBand = data.bb.upper[len-1], lastLowerBand = data.bb.lower[len-1]; if (lastSma20 === null || lastSma50 === null || lastRsi === null || lastMacd === null) return { rating: 'HOLD', explanation: 'Not enough historical data.' }; if (lastSma20 > lastSma50) score += 2; else if (lastSma20 < lastSma50) score -= 2; if (lastClose > lastSma20) score += 1; if (lastClose < lastSma20) score -= 1; if (lastVolume > lastVolumeSma20 * 1.5) score += (lastClose > prevClose ? 1.5 : -1.5); if (lastRsi < 30 && lastClose < lastLowerBand) score += 2.5; else if (lastRsi < 30) score += 1.5; if (lastRsi > 70 && lastClose > lastUpperBand) score -= 2.5; else if (lastRsi > 70) score -= 1.5; if (lastMacd > lastMacdSignal) score += 2; if (lastMacd < lastMacdSignal) score -= 2; if (score >= 3) return { rating: 'BUY', explanation: 'Strong bullish signals from multiple indicators.' }; if (score <= -3) return { rating: 'SELL', explanation: 'Strong bearish signals detected.' }; return { rating: 'HOLD', explanation: 'Indicators are neutral or conflicting.' }; }
        function findChartSignals(dates, closes, sma20, sma50) { const signals = []; for (let i = 1; i < dates.length; i++) { if (sma20[i-1] === null || sma50[i-1] === null) continue; if (sma20[i-1] <= sma50[i-1] && sma20[i] > sma50[i]) { signals.push({ date: dates[i], price: closes[i], type: 'entry', reason: 'Golden Cross' }); } if (sma20[i-1] >= sma50[i-1] && sma20[i] < sma50[i]) { signals.push({ date: dates[i], price: closes[i], type: 'exit', reason: 'Death Cross' }); } } return signals; }

        // --- Charting and UI Functions ---
        function createOrUpdateChart(canvasId, data, type = 'line', scalesOptions = {}, signals = [], annotations = []) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const pointAnnotations = {};
            signals.forEach((signal, index) => { pointAnnotations[`signal${index}`] = { type: 'point', xValue: signal.date, yValue: signal.price, backgroundColor: signal.type === 'entry' ? 'rgba(34, 197, 94, 0.7)' : 'rgba(239, 68, 68, 0.7)', borderColor: signal.type === 'entry' ? '#22c55e' : '#ef4444', radius: 6, pointStyle: 'triangle', rotation: signal.type === 'entry' ? 0 : 180, label: { content: signal.reason, enabled: true, position: 'start', yAdjust: signal.type === 'entry' ? -15 : 15, backgroundColor: 'rgba(0,0,0,0.7)', font: { size: 10 } } } });
            const timeUnit = canvasId.includes('intraday') ? 'minute' : 'day';
            const timeTooltipFormat = canvasId.includes('intraday') ? 'MMM dd, HH:mm' : 'MMM dd, yyyy';
            chartInstances[canvasId] = new Chart(ctx, {
                 type: type,
                 data: data, 
                 options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, scales: { x: { type: 'time', time: { unit: timeUnit, tooltipFormat: timeTooltipFormat }, ticks: { color: '#9ca3af', maxTicksLimit: 8 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }, y: { ...scalesOptions, ticks: { color: '#9ca3af' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } } }, plugins: { legend: { display: false }, tooltip: { titleColor: '#ffffff', bodyColor: '#d1d5db', backgroundColor: '#1f2937', borderColor: '#4b5563', borderWidth: 1 }, annotation: { annotations: {...pointAnnotations, ...annotations} } } } 
            });
        }
        function setupInfoTooltips() { document.querySelectorAll('.info-icon').forEach(icon => { const tooltipId = icon.dataset.tooltip; const tooltip = document.getElementById(tooltipId); icon.addEventListener('mouseenter', () => tooltip.style.display = 'block'); icon.addEventListener('mouseleave', () => tooltip.style.display = 'none'); }); }
        function showLoader(show) { loader.classList.toggle('hidden', !show); }
        function showError(message) { errorTextEl.textContent = message; errorMessageDiv.classList.remove('hidden'); }
        function hideError() { errorMessageDiv.classList.add('hidden'); }
    </script>
</body>
</html>
